name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual release)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.2.0)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Check tag doesn't exist
        run: |
          VERSION="${{ inputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists!"
            exit 1
          fi
          echo "Tag v$VERSION is available"

  test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Build
        run: nix build --quiet

      - name: Test
        run: nix run .#unit-tests --quiet

  release:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ !inputs.dry_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: paolino/dev-assets/setup-nix@v0.0.1
        with:
          cachix-auth-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create version bump PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="release/v${{ inputs.version }}"
          git checkout -b "$BRANCH"
          npm version "${{ inputs.version }}" --no-git-tag-version
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ inputs.version }}"
          git push -u origin "$BRANCH"
          gh pr create \
            --title "chore: release v${{ inputs.version }}" \
            --body "Automated version bump for release v${{ inputs.version }}" \
            --base main \
            --head "$BRANCH"

      - name: Wait for CI and merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="release/v${{ inputs.version }}"
          echo "Waiting for CI checks to complete..."
          gh pr checks "$BRANCH" --watch --fail-level all
          echo "CI passed, merging PR..."
          gh pr merge "$BRANCH" --rebase --delete-branch

      - name: Create and push tag
        run: |
          git fetch origin main
          git checkout main
          git pull origin main
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --generate-notes

  dry-run-summary:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ inputs.dry_run }}
    steps:
      - name: Dry run summary
        run: |
          echo "Dry run completed successfully!"
          echo ""
          echo "Would have:"
          echo "  - Updated package.json version to ${{ inputs.version }}"
          echo "  - Created tag v${{ inputs.version }}"
          echo "  - Created GitHub Release v${{ inputs.version }}"
