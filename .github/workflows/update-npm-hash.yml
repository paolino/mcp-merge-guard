name: Update npm hash

on:
  pull_request_target:
    branches: [main]
    paths:
      - package-lock.json

permissions:
  contents: write

jobs:
  update-hash:
    if: startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - uses: cachix/install-nix-action@v27

      - name: Compute npm hash
        id: hash
        run: |
          NEW_HASH=$(nix-shell -p prefetch-npm-deps --run "prefetch-npm-deps package-lock.json 2>/dev/null")
          OLD_HASH=$(grep -oP 'npmDepsHash = "\K[^"]+' flake.nix | head -1)
          echo "old=$OLD_HASH"
          echo "new=$NEW_HASH"
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "hash=$NEW_HASH" >> "$GITHUB_OUTPUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update flake.nix
        if: steps.hash.outputs.changed == 'true'
        run: |
          sed -i "s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${{ steps.hash.outputs.hash }}\"|g" flake.nix

      - name: Commit and push
        if: steps.hash.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add flake.nix
          git commit -m "fix: update npmDepsHash for release"
          git push
